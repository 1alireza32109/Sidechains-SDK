package com.horizen

import java.lang.{Byte => JByte, Long => JLong}
import java.net.InetSocketAddress
import java.util.{ArrayList => JArrayList, HashMap => JHashMap}

import com.horizen.block.{SidechainBlock, SidechainBlockSerializer}
import com.horizen.box.{NoncedBox, RegularBox}
import com.horizen.companion.SidechainTransactionsCompanion
import com.horizen.proposition.{Proposition, PublicKey25519Proposition}
import com.horizen.secret.{PrivateKey25519, PrivateKey25519Creator}
import com.horizen.transaction.{RegularTransaction, SidechainTransaction, TransactionSerializer}
import com.horizen.utils.BytesUtils
import com.typesafe.config.Config
import javafx.util.{Pair => JPair}
import net.ceedubs.ficus.Ficus._
import net.ceedubs.ficus.readers.ArbitraryTypeReader._
import scorex.core.settings.ScorexSettings.readConfigFromPath
import scorex.core.settings.{ScorexSettings, SettingsReaders}
import scorex.util.{ScorexLogging, _}

case class WebSocketClientSettings(
                                    remoteAddress: InetSocketAddress = new InetSocketAddress("127.0.0.1", 8888),
                                    connectionTimeout : Long = 5000,
                                    connectionTimeUnit :String = "MILLISECONDS")

case class SidechainSettings(scorexSettings: ScorexSettings, webSocketClientSettings: WebSocketClientSettings) {

  protected val sidechainTransactionsCompanion: SidechainTransactionsCompanion = SidechainTransactionsCompanion(new JHashMap[JByte, TransactionSerializer[SidechainTypes#SCBT]]())

  val secretKey = PrivateKey25519Creator.getInstance().generateSecret("genesis_seed%d".format(123).getBytes)

  val targetSecretKey1 = PrivateKey25519Creator.getInstance().generateSecret("target1".getBytes)
  val targetSecretKey2 = PrivateKey25519Creator.getInstance().generateSecret("target2".getBytes)

  private def getGenesisTransactions: Seq[SidechainTransaction[Proposition, NoncedBox[Proposition]]] = {
    val fee = 0
    val timestamp = 1547798549470L

    val from = new JArrayList[JPair[RegularBox, PrivateKey25519]]
    val to = new JArrayList[JPair[PublicKey25519Proposition, JLong]]

    val creator = PrivateKey25519Creator.getInstance

    from.add(new JPair[RegularBox, PrivateKey25519](new RegularBox(secretKey.publicImage, 1, 30000L), secretKey))

    to.add(new JPair[PublicKey25519Proposition, JLong](targetSecretKey1.publicImage, 10000L))
    to.add(new JPair[PublicKey25519Proposition, JLong](targetSecretKey2.publicImage, 20000L))

    val transaction = RegularTransaction.create(from, to, fee, timestamp)
    val id = transaction.id
    Seq(transaction.asInstanceOf[SidechainTransaction[Proposition, NoncedBox[Proposition]]])
  }

  lazy val genesisBlock : Option[SidechainBlock] = Some(
    new SidechainBlockSerializer(sidechainTransactionsCompanion).parseBytes(
      // Hex representation of Sidehcain block generated by commented code below and above.
      BytesUtils.fromHexString("0000000000000000000000000000000000000000000000000000000000000000aaf3d3d40bf20302ec03e20200000020ad89c3f9897d845dac803e2fa1932c1831111ed9096570552cecc741330d9c04572ab9876c28da8ef2a77a34c10519126431b8ac69d82be77f9d5a9720a281eded20867459bdf3451c24a9593d6a0723c0c1093ee3840b4933dc99aa8b73d1b6d6b5775d090f0f202300f82fc2eec83b401cc5f759e94fd48656b00202a24efe2905670c46f300002414c11315d47ea59f42274f1f7fd74669db8b283ade9e48e72a51a056c01b1608776a2b170080010000000000000000000000000000000000000000000000000000000000000001b6d1738baa99dc33490b84e33e09c1c023076a3d59a9241c45f3bd59748620edd00302ca03010000000000000000000001685ffb93de0000003202603cfbf879f515ff96c9031ebcbc006170dd6c30522a35d488c7472c4a75dc11480000000000000001000000000000753000000043044040bf126e8d1db806f1b7d6ec11449c7c9218228c80675c8a46ebcef53b57c4ee401d71af035aacbc874e10529cb5bf85e51f1d6583882d32d2a05683dfd776301600000000000027100000000000004e20000000430280015271271f224b9de6bfa7a752d27162c483f0bf981226a32f6f17bf18361afc6b2804ca72530507047de83223fdbeb77bb2415bd25255ac3ba06660a080a648073cfbf879f515ff96c9031ebcbc006170dd6c30522a35d488c7472c4a75dc1148298815f0891cf2d385200260d392527e4c08b8b0aaf033cc01ebafc3bb9f272c9b1ceb99cdfd5405aa8737ef30e43dcbb40f263719d030e7dc0531152a37ef03")
    )
  )

  /*Some(new SidechainBlock(
    SidechainSettings.genesisParentBlockId,
    1565162709L, // Wednesday, August 7, 2019 7:25:09 AM
    Seq(),
    getGenesisTransactions,
    secretKey.publicImage(),
    new Signature25519(BytesUtils.fromHexString(
      "28f65fdffb6a0ecffd308445e1ef551935e614a45be9dc936467abcd82297fd5856a3395ae5854e13de9db576a88422da39970a93f0b21ba5b659b3f6cae0100")
    ),
    sidechainTransactionsCompanion
   )
  )*/
}

object SidechainSettings
  extends ScorexLogging
    with SettingsReaders
{

  val genesisParentBlockId : scorex.core.block.Block.BlockId = bytesToId(new Array[Byte](32))

  def read(userConfigPath: Option[String]): SidechainSettings = {
    fromConfig(readConfigFromPath(userConfigPath, "scorex"))
    //new SidechainSettings(ScorexSettings.read(userConfigPath))
  }

  private def fromConfig(config: Config): SidechainSettings = {
    val webSocketClientSettings = config.as[WebSocketClientSettings]("scorex.websocket")
    val scorexSettings = config.as[ScorexSettings]("scorex")
    SidechainSettings(scorexSettings, webSocketClientSettings)
  }
  /*
  implicit val networkSettingsValueReader: ValueReader[SDKSettings] =
    (cfg: Config, path: String) => fromConfig(cfg.getConfig(path))
  */

  /*
  private def fromConfig(config: Config): HybridSettings = {
    log.info(config.toString)
    val walletSettings = config.as[WalletSettings]("scorex.wallet")
    val miningSettings = config.as[HybridMiningSettings]("scorex.miner")
    val scorexSettings = config.as[ScorexSettings]("scorex")
    HybridSettings(miningSettings, walletSettings, scorexSettings)
  }*/
}